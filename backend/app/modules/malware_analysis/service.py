"""
Service pour le module Malware Analysis
Logique m√©tier pour l'analyse de malware avec VirusTotal
"""
from typing import List, Optional
import hashlib
import re
from datetime import datetime
import uuid

from app.models.schemas import (
    MalwareAnalysisRequest,
    MalwareAnalysisResponse,
    ThreatLevel
)
from app.modules.malware_analysis.virustotal_client import virustotal_client


class MalwareAnalysisService:
    """Service d'analyse de malware"""
    
    def __init__(self):
        # TODO: Remplacer par une vraie DB
        self.analysis_db = {}
        
        # Extensions de fichiers suspects
        self.suspicious_extensions = [
            '.exe', '.dll', '.bat', '.cmd', '.scr', '.vbs', '.js', '.jar',
            '.msi', '.ps1', '.sh', '.app', '.deb', '.rpm', '.apk'
        ]
    
    async def analyze_malware(self, request: MalwareAnalysisRequest) -> MalwareAnalysisResponse:
        """
        Analyse un fichier pour d√©tecter des malwares avec VirusTotal
        """
        analysis_id = f"mal_{uuid.uuid4().hex[:8]}"
        
        is_malicious = False
        confidence = 0.0
        threat_type = None
        indicators = []
        threat_level = ThreatLevel.LOW
        
        # Analyse heuristique basique
        heuristic_result = self._heuristic_analysis(request.file_name)
        indicators.extend(heuristic_result['indicators'])
        
        # Si un hash est fourni, interroger VirusTotal
        if request.file_hash:
            vt_result = await virustotal_client.get_file_report(request.file_hash)
            
            if vt_result and vt_result.get("found"):
                # Analyser les r√©sultats VirusTotal
                malicious_count = vt_result.get("malicious", 0)
                suspicious_count = vt_result.get("suspicious", 0)
                total_engines = vt_result.get("total_engines", 0)
                
                if total_engines > 0:
                    # Calculer le pourcentage de d√©tection
                    detection_rate = (malicious_count + suspicious_count) / total_engines
                    confidence = detection_rate
                    
                    if malicious_count > 5:
                        is_malicious = True
                        threat_level = ThreatLevel.CRITICAL
                        threat_type = "Malware"
                        indicators.append(f"üö® Detected by {malicious_count}/{total_engines} antivirus engines")
                    elif malicious_count > 0 or suspicious_count > 3:
                        is_malicious = True
                        threat_level = ThreatLevel.HIGH
                        threat_type = "Suspicious"
                        indicators.append(f"‚ö†Ô∏è Flagged by {malicious_count + suspicious_count}/{total_engines} engines")
                    else:
                        indicators.append(f"‚úì Clean - Only {malicious_count + suspicious_count}/{total_engines} detections")
                    
                    # Ajouter les noms de d√©tection
                    detection_names = vt_result.get("detection_names", [])
                    if detection_names:
                        indicators.append(f"Detection names: {', '.join(detection_names[:3])}")
                    
                    indicators.append("‚úì Analysis powered by VirusTotal")
                else:
                    indicators.append("‚ÑπÔ∏è File analyzed but no engine results")
            elif vt_result:
                indicators.append("‚ÑπÔ∏è File not found in VirusTotal database")
                confidence = heuristic_result['confidence']
                is_malicious = heuristic_result['is_suspicious']
                threat_level = heuristic_result['threat_level']
        else:
            # Sans hash, utiliser seulement l'analyse heuristique
            confidence = heuristic_result['confidence']
            is_malicious = heuristic_result['is_suspicious']
            threat_level = heuristic_result['threat_level']
            if is_malicious:
                threat_type = "Suspicious"
            indicators.append("‚ö†Ô∏è No hash provided - heuristic analysis only")
        
        result = MalwareAnalysisResponse(
            analysis_id=analysis_id,
            file_name=request.file_name,
            is_malicious=is_malicious,
            confidence=confidence,
            threat_type=threat_type,
            indicators=indicators if indicators else ["No indicators found"],
            threat_level=threat_level,
            timestamp=datetime.utcnow()
        )
        
        self.analysis_db[analysis_id] = result
        return result
    
    def _heuristic_analysis(self, file_name: str) -> dict:
        """Analyse heuristique bas√©e sur le nom du fichier"""
        indicators = []
        is_suspicious = False
        confidence = 0.0
        threat_level = ThreatLevel.LOW
        
        # V√©rifier l'extension
        file_lower = file_name.lower()
        for ext in self.suspicious_extensions:
            if file_lower.endswith(ext):
                indicators.append(f"‚ö†Ô∏è Executable file extension detected: {ext}")
                is_suspicious = True
                confidence = 0.4
                threat_level = ThreatLevel.MEDIUM
                break
        
        # Mots-cl√©s suspects dans le nom
        suspicious_keywords = [
            'crack', 'keygen', 'patch', 'hack', 'trojan', 'virus',
            'malware', 'ransomware', 'backdoor', 'exploit', 'payload'
        ]
        
        for keyword in suspicious_keywords:
            if keyword in file_lower:
                indicators.append(f"üö© Suspicious keyword in filename: '{keyword}'")
                is_suspicious = True
                confidence = 0.7
                threat_level = ThreatLevel.HIGH
                break
        
        # Double extensions suspicieuses
        if file_name.count('.') > 1:
            parts = file_name.split('.')
            if len(parts) > 2 and parts[-2] in ['pdf', 'doc', 'jpg', 'png', 'txt']:
                indicators.append("üö© Double extension detected (possible disguise)")
                is_suspicious = True
                confidence = 0.8
                threat_level = ThreatLevel.HIGH
        
        # Caract√®res suspects
        if any(char in file_name for char in ['$', '!', '@', '#', '%']):
            indicators.append("Unusual characters in filename")
            confidence = max(confidence, 0.3)
        
        if not is_suspicious:
            indicators.append("‚úì Filename appears normal")
            confidence = 0.95  # Confiance que c'est clean
        
        return {
            'is_suspicious': is_suspicious,
            'confidence': confidence,
            'threat_level': threat_level,
            'indicators': indicators
        }
    
    async def get_history(self, limit: int = 10) -> List[MalwareAnalysisResponse]:
        """R√©cup√®re l'historique des analyses"""
        # TODO: R√©cup√©rer depuis la DB
        return list(self.analysis_db.values())[:limit]
    
    async def get_analysis(self, analysis_id: str) -> Optional[MalwareAnalysisResponse]:
        """R√©cup√®re une analyse sp√©cifique"""
        return self.analysis_db.get(analysis_id)
    
    async def analyze_file_content(
        self, 
        file_name: str, 
        file_content: bytes
    ) -> MalwareAnalysisResponse:
        """
        Analyse un fichier √† partir de son contenu (bytes)
        
        1. Calcule le hash SHA-256 en m√©moire
        2. Interroge VirusTotal avec ce hash
        3. Retourne le rapport complet
        
        Args:
            file_name: Nom du fichier
            file_content: Contenu binaire du fichier
            
        Returns:
            MalwareAnalysisResponse avec les r√©sultats de l'analyse
        """
        analysis_id = f"mal_{uuid.uuid4().hex[:8]}"
        
        try:
            # Calculer le hash SHA-256 du fichier
            sha256_hash = hashlib.sha256(file_content).hexdigest()
            print(f"üîê SHA-256: {sha256_hash}")
            
            is_malicious = False
            confidence = 0.0
            threat_type = None
            indicators = []
            threat_level = ThreatLevel.LOW
            
            # Analyse heuristique basique (nom de fichier)
            heuristic_result = self._heuristic_analysis(file_name)
            indicators.extend(heuristic_result['indicators'])
            
            # Interroger VirusTotal avec le hash
            print(f"üîç Interrogation VirusTotal...")
            vt_result = await virustotal_client.get_file_report(sha256_hash)
            
            if vt_result and vt_result.get("found"):
                # Fichier trouv√© dans VirusTotal
                malicious_count = vt_result.get("malicious", 0)
                suspicious_count = vt_result.get("suspicious", 0)
                harmless_count = vt_result.get("harmless", 0)
                total_engines = vt_result.get("total_engines", 0)
                
                print(f"üìä VirusTotal: {malicious_count} malicious, {suspicious_count} suspicious, {harmless_count} harmless ({total_engines} engines)")
                
                if total_engines > 0:
                    # Calculer le pourcentage de d√©tection
                    detection_rate = (malicious_count + suspicious_count) / total_engines
                    confidence = detection_rate
                    
                    if malicious_count > 5:
                        # Plus de 5 moteurs d√©tectent = MALWARE confirm√©
                        is_malicious = True
                        threat_level = ThreatLevel.CRITICAL
                        threat_type = "Malware"
                        indicators.append(f"üö® MALWARE D√âTECT√â par {malicious_count}/{total_engines} moteurs antivirus")
                    elif malicious_count > 2 or suspicious_count > 5:
                        # 3-5 d√©tections = Menace √©lev√©e
                        is_malicious = True
                        threat_level = ThreatLevel.HIGH
                        threat_type = "Suspicious"
                        indicators.append(f"‚ö†Ô∏è Marqu√© suspect par {malicious_count + suspicious_count}/{total_engines} moteurs")
                    elif malicious_count > 0 or suspicious_count > 2:
                        # 1-2 d√©tections = Menace moyenne
                        is_malicious = True
                        threat_level = ThreatLevel.MEDIUM
                        threat_type = "Potentially Unwanted"
                        indicators.append(f"‚ö†Ô∏è {malicious_count + suspicious_count}/{total_engines} d√©tections (faible risque)")
                    else:
                        # Aucune ou tr√®s peu de d√©tections = Clean
                        indicators.append(f"‚úÖ Fichier propre - {harmless_count}/{total_engines} moteurs confirment")
                        confidence = 0.95  # Haute confiance que c'est clean
                    
                    # Ajouter les noms de d√©tection (top 3)
                    detection_names = vt_result.get("detection_names", [])
                    if detection_names:
                        indicators.append(f"üîç D√©tections: {', '.join(detection_names[:3])}")
                    
                    # Infos fichier
                    file_type = vt_result.get("file_type", "Unknown")
                    file_size = vt_result.get("file_size", len(file_content))
                    indicators.append(f"üìÑ Type: {file_type} | Taille: {file_size} bytes")
                    
                    indicators.append("‚úÖ Analyse propuls√©e par VirusTotal")
                else:
                    indicators.append("‚ÑπÔ∏è Fichier analys√© mais aucun r√©sultat moteur")
                    
            elif vt_result and not vt_result.get("found"):
                # Fichier inconnu de VirusTotal
                indicators.append("‚ÑπÔ∏è Fichier INCONNU dans la base VirusTotal")
                indicators.append("üí° Ce fichier n'a jamais √©t√© analys√© par VirusTotal")
                indicators.append("‚ö†Ô∏è Impossible de confirmer s'il est malveillant ou s√ªr")
                
                # Utiliser l'analyse heuristique
                confidence = heuristic_result['confidence']
                is_malicious = heuristic_result['is_suspicious']
                threat_level = heuristic_result['threat_level']
                
                if is_malicious:
                    threat_type = "Unknown (Heuristic)"
                    indicators.append("üîç Analyse heuristique sugg√®re un risque potentiel")
                else:
                    indicators.append("üîç Analyse heuristique ne d√©tecte pas de menace √©vidente")
            else:
                # Erreur API VirusTotal
                indicators.append("‚ùå Impossible de contacter VirusTotal (v√©rifiez la cl√© API)")
                confidence = heuristic_result['confidence']
                is_malicious = heuristic_result['is_suspicious']
                threat_level = heuristic_result['threat_level']
            
            # Ajouter le hash pour r√©f√©rence
            indicators.append(f"üîê SHA-256: {sha256_hash}")
            
            result = MalwareAnalysisResponse(
                analysis_id=analysis_id,
                file_name=file_name,
                is_malicious=is_malicious,
                confidence=confidence,
                threat_type=threat_type,
                indicators=indicators if indicators else ["Aucun indicateur trouv√©"],
                threat_level=threat_level,
                timestamp=datetime.utcnow()
            )
            
            # Sauvegarder dans la DB
            self.analysis_db[analysis_id] = result
            return result
            
        except Exception as e:
            print(f"‚ùå ERROR analyze_file_content: {type(e).__name__}: {str(e)}")
            import traceback
            traceback.print_exc()
            
            # Retourner une r√©ponse d'erreur
            return MalwareAnalysisResponse(
                analysis_id=analysis_id,
                file_name=file_name,
                is_malicious=False,
                confidence=0.0,
                threat_type=None,
                indicators=[f"‚ùå Erreur lors de l'analyse: {str(e)}"],
                threat_level=ThreatLevel.LOW,
                timestamp=datetime.utcnow()
            )

