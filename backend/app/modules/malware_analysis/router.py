"""
Router pour le module Malware Analysis
Gestion des endpoints d'analyse de malware
"""
from fastapi import APIRouter, HTTPException, UploadFile, File
from typing import List
from app.models.schemas import (
    MalwareAnalysisRequest,
    MalwareAnalysisResponse,
    BaseResponse,
    ThreatLevel
)
from app.modules.malware_analysis.service import MalwareAnalysisService
from datetime import datetime
import uuid

router = APIRouter()
service = MalwareAnalysisService()


@router.post("/analyze", response_model=MalwareAnalysisResponse)
async def analyze_file(request: MalwareAnalysisRequest):
    """
    Analyse un fichier pour d√©tecter des malwares
    
    - **file_hash**: Hash du fichier (optionnel)
    - **file_name**: Nom du fichier √† analyser
    - **analysis_depth**: Profondeur de l'analyse (quick, standard, deep)
    """
    try:
        result = await service.analyze_malware(request)
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Erreur lors de l'analyse: {str(e)}")


@router.post("/scan-file", response_model=MalwareAnalysisResponse)
async def scan_file(file: UploadFile = File(...)):
    """
    Upload et analyse un fichier avec VirusTotal
    
    - **file**: Fichier √† analyser (exe, pdf, docx, etc.)
    
    Logique:
    1. Calcule le hash SHA-256 du fichier en m√©moire
    2. Interroge VirusTotal avec ce hash
    3. Retourne le rapport d'analyse (ou "fichier inconnu" si pas dans VT)
    
    ‚ö†Ô∏è Le fichier n'est PAS sauvegard√© sur le disque pour des raisons de s√©curit√©
    """
    try:
        # Validation du fichier
        if not file.filename:
            raise HTTPException(
                status_code=400,
                detail="Le fichier doit avoir un nom"
            )
        
        # Limiter la taille du fichier (100 MB max)
        max_size = 100 * 1024 * 1024  # 100 MB
        file_content = await file.read()
        
        if len(file_content) > max_size:
            raise HTTPException(
                status_code=400,
                detail=f"Fichier trop volumineux (max 100 MB)"
            )
        
        print(f"üìÅ Fichier re√ßu: {file.filename} ({len(file_content)} bytes)")
        
        # Analyse avec le service
        result = await service.analyze_file_content(file.filename, file_content)
        return result
        
    except HTTPException:
        raise
    except Exception as e:
        print(f"‚ùå ERROR scan_file: {type(e).__name__}: {str(e)}")
        import traceback
        traceback.print_exc()
        
        raise HTTPException(
            status_code=500,
            detail=f"Erreur lors de l'analyse du fichier: {str(e)}"
        )


@router.post("/upload", response_model=MalwareAnalysisResponse)
async def upload_and_analyze(file: UploadFile = File(...)):
    """
    Upload et analyse un fichier (alias de /scan-file pour r√©trocompatibilit√©)
    
    - **file**: Fichier √† analyser
    """
    return await scan_file(file)


@router.get("/history", response_model=List[MalwareAnalysisResponse])
async def get_analysis_history(limit: int = 10):
    """R√©cup√®re l'historique des analyses de malware"""
    try:
        history = await service.get_history(limit=limit)
        return history
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Erreur: {str(e)}")


@router.get("/{analysis_id}", response_model=MalwareAnalysisResponse)
async def get_analysis_result(analysis_id: str):
    """R√©cup√®re les r√©sultats d'une analyse sp√©cifique"""
    try:
        result = await service.get_analysis(analysis_id)
        if not result:
            raise HTTPException(status_code=404, detail="Analyse non trouv√©e")
        return result
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Erreur: {str(e)}")

